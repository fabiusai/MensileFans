<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Mensile Followers</title>
    <link rel="icon" href="favicon.ico">
    <!-- Libreria per leggere i file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Libreria D3.js per i grafici -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Nunito Sans (con peso regular 400 e 700) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Colori UI Principali (Header, Bottoni, etc) */
            --primary-ui-blue: #004282;
            --primary-ui-yellow: #ffd400;
            
            /* Colori Grafico dal UI Kit */
            --chart-title-blue: #0431AE;
            --chart-bar-blue: #bfd7fd;
            --chart-text-grey: #7b7b7a;
            
            /* Colori Generali */
            --background-color: #f4f7fa;
            --text-color: #333333;
            --card-background: #ffffff;
            --border-color: #e0e0e0;
            --font-family: 'Nunito Sans', 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-ui-blue);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            border-bottom: 5px solid var(--primary-ui-yellow);
        }
        
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .upload-section {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            margin-bottom: 2rem;
        }

        .upload-section h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--primary-ui-blue);
        }

        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .drop-zone.dragover {
            background-color: #e9f5ff;
            border-color: var(--primary-ui-blue);
        }

        .drop-zone p {
            margin: 0;
            font-size: 1.1rem;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .button-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .nav-button {
            background-color: #fff;
            color: var(--primary-ui-blue);
            border: 2px solid var(--primary-ui-blue);
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.3s, color 0.3s;
            font-family: var(--font-family);
            font-size: 0.9rem;
        }

        .nav-button:hover, .nav-button.active {
            background-color: var(--primary-ui-blue);
            color: white;
        }

        .report-section {
            background-color: var(--card-background);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .hidden {
            display: none;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .data-item, .table-wrapper, .chart-wrapper {
            background-color: #f8f9fc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .data-item h3, .table-wrapper h3 {
            font-size: 1.1rem;
            color: var(--primary-ui-blue);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .data-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-ui-blue);
        }

        .data-change {
            font-size: 1rem;
            font-weight: 700;
        }

        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
        }

        th {
            background-color: #eef2f7;
            font-weight: 700;
            color: var(--primary-ui-blue);
        }

        tr:last-child td {
            border-bottom: none;
        }
        
        tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        .copy-button, .export-svg-btn, .copy-svg-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            color: #495057;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .copy-button:hover, .export-svg-btn:hover, .copy-svg-btn:hover {
            background-color: #dee2e6;
        }

        .chart-controls {
            position: static;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chart-controls .export-svg-btn, .chart-controls .copy-svg-btn {
            position: static;
            width: auto;
            height: auto;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .chart-controls .copy-svg-btn {
           background-color: var(--primary-ui-blue);
           color: white;
           border-color: var(--primary-ui-blue);
        }
        .chart-controls .copy-svg-btn:hover {
            background-color: #003366;
        }
        
        .chart-container {
            width: 100%;
        }

        /* Stili per il grafico SVG */
        .benchmark-chart {
            width: 100%;
            height: auto;
        }
        .benchmark-chart .axis-label, .benchmark-chart .tick text {
            font-family: 'Nunito Sans', sans-serif;
            font-weight: 400;
            fill: var(--chart-text-grey);
        }
        .benchmark-chart .bar-label {
            font-family: 'Nunito Sans', sans-serif;
            font-weight: 700;
            fill: var(--chart-title-blue);
        }
        .benchmark-chart .grid-line {
            stroke: #e0e0e0;
            stroke-dasharray: 2,2;
        }

        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-ui-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <header>
        <h1 class="text-3xl font-bold">Report Mensile Followers</h1>
    </header>

    <main class="main-container">
        <section class="upload-section">
            <h2>Carica i file Excel</h2>
            <div id="drop-zone" class="drop-zone">
                <input type="file" id="file-input" multiple class="file-input" accept=".xlsx, .xls, .csv">
                <p>Trascina i file qui o clicca per selezionarli</p>
            </div>
        </section>

        <div id="report-content" class="hidden">
            <nav id="button-nav" class="button-nav"></nav>
            <div id="sections-wrapper"></div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const reportContent = document.getElementById('report-content');
        const buttonNav = document.getElementById('button-nav');
        const sectionsWrapper = document.getElementById('sections-wrapper');
        const loader = document.getElementById('loader');

        // Gestione Drag & Drop
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                handleFiles(files);
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFiles(fileInput.files);
            }
        });

        function showLoader() { loader.style.display = 'flex'; }
        function hideLoader() { loader.style.display = 'none'; }

        async function handleFiles(files) {
            showLoader();
            const fileData = {};
            for (const file of files) {
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    fileData[file.name] = workbook;
                } catch (error) {
                    console.error(`Errore nel leggere il file ${file.name}:`, error);
                    alert(`Non è stato possibile leggere il file ${file.name}. Assicurati che sia un file Excel valido.`);
                }
            }
            if (Object.keys(fileData).length > 0) {
                processFiles(fileData);
            }
            hideLoader();
        }
        
        function getSheetData(workbook, sheetName) {
            if (!workbook.SheetNames.includes(sheetName)) return [];
            return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
        }
        
        function findValueByLabel(data, label) {
            for (const row of data) {
                if (row && row[0] && typeof row[0] === 'string' && row[0].trim().toLowerCase() === label.toLowerCase()) {
                    return row[1];
                }
            }
            return null;
        }
        
        function findRowIndex(data, label) {
            return data.findIndex(row => row && row[0] && typeof row[0] === 'string' && row[0].trim().toLowerCase().startsWith(label.toLowerCase()));
        }

        function formatNumber(n) {
            if (typeof n !== 'number') return String(n).replace('.',',');

            if (n >= 1000000) {
                const millions = n / 1000000;
                let formatted = millions.toFixed(2);
                if (formatted.endsWith('.00')) {
                    formatted = formatted.substring(0, formatted.length - 3);
                }
                else if (formatted.endsWith('0')) {
                    formatted = formatted.substring(0, formatted.length - 1);
                }
                return formatted.replace('.', ',') + 'M';
            }

            if (n >= 1000) {
                return Math.round(n / 1000) + 'K';
            }
            return n.toLocaleString('it-IT');
        }

        function formatNumberWithThousands(n, decimalPlaces = 0) {
            if (typeof n !== 'number') return String(n).replace('.',',');
            const options = {};
            if (decimalPlaces > 0) {
                options.minimumFractionDigits = decimalPlaces;
                options.maximumFractionDigits = decimalPlaces;
            }
            return n.toLocaleString('it-IT', options);
        }

        function createBenchmarkChart(containerId, data, title) {
            const container = d3.select(containerId);
            if (container.empty()) {
                console.error(`Container con ID ${containerId} non trovato.`);
                return;
            }
            container.selectAll("*").remove();

            const width = 2300;
            const height = 519;
            const margin = { top: 80, right: 40, bottom: 200, left: 140 }; // Aumentati margini per font più grandi

            const svg = container.append("svg")
                .attr("width", "100%") // Adatta alla larghezza
                .attr("height", "100%") // Adatta all'altezza
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("class", "benchmark-chart");

            const x = d3.scaleBand()
                .domain(data.map(d => d.name))
                .range([margin.left, width - margin.right])
                .padding(0.3); // Ridotto per allargare le barre e avvicinarle

            const yMax = d3.max(data, d => d.value);
            const y = d3.scaleLinear()
                .domain([0, yMax * 1.2]) // Aumentato yMax per più spazio in alto
                .range([height - margin.bottom, margin.top]);

            const xAxis = d3.axisBottom(x).tickSize(0);
            const xAxisGroup = svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(xAxis);
            
            xAxisGroup.selectAll("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end")
                .attr("dy", "0.8em") 
                .style("font-size", "26px"); // Ingrandito significativamente
            xAxisGroup.select(".domain").remove();

            const yTicks = y.ticks(5).filter(tick => tick > 0);
            const yAxis = d3.axisLeft(y)
                .tickValues(yTicks)
                .tickFormat(formatNumber)
                .tickSize(-(width - margin.left - margin.right));

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(yAxis)
                .call(g => g.select(".domain").remove())
                .call(g => g.selectAll(".tick line").attr("class", "grid-line"))
                .call(g => g.selectAll(".tick text")
                    .attr("class", "axis-label")
                    .attr("dx", "-0.5em")
                    .style("font-size", "26px") // Ingrandito significativamente
                );

            svg.append("g")
                .selectAll("rect")
                .data(data)
                .join("rect")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.value))
                .attr("height", d => y(0) - y(d.value))
                .attr("width", x.bandwidth())
                .attr("fill", d => d.name.toLowerCase().includes('poste') ? 'var(--chart-title-blue)' : 'var(--chart-bar-blue)');

            svg.append("g")
                .selectAll("text")
                .data(data)
                .join("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 12)
                .attr("text-anchor", "middle")
                .style("font-size", "26px") // Ingrandito
                .text(d => formatNumber(d.value));

            // Titolo
            svg.append("text")
                .attr("x", margin.left)
                .attr("y", margin.top - 40)
                .attr("text-anchor", "start")
                .style("font-size", "32px") // Ingrandito
                .style("font-weight", "bold")
                .style("fill", "var(--chart-title-blue)")
                .style("font-family", "var(--font-family)")
                .text(title);

            // Linea sotto il titolo
            svg.append("line")
                .attr("x1", margin.left)
                .attr("y1", margin.top - 25)
                .attr("x2", margin.left + 450) 
                .attr("y2", margin.top - 25)
                .attr("stroke", "var(--chart-title-blue)")
                .attr("stroke-width", 2);
        }

        function getStyledSvgString(svgElement) {
            const svgClone = svgElement.cloneNode(true);
            const allOriginalElements = svgElement.querySelectorAll('*');
            const allClonedElements = svgClone.querySelectorAll('*');

            allOriginalElements.forEach((origEl, index) => {
                const cloneEl = allClonedElements[index];
                const computedStyle = window.getComputedStyle(origEl);
                let inlineStyle = "";
                for (let i = 0; i < computedStyle.length; i++) {
                    const prop = computedStyle[i];
                    inlineStyle += `${prop}: ${computedStyle.getPropertyValue(prop)}; `;
                }
                cloneEl.setAttribute('style', inlineStyle);
            });
            return new XMLSerializer().serializeToString(svgClone);
        }

        async function copySvgToClipboard(svgElement, button) {
            showFeedbackOnCopyButton(button, 'Copiando...');
            try {
                const svgData = getStyledSvgString(svgElement);
                const canvas = document.createElement("canvas");
                const width = 2300; // Usa la larghezza fissa per la copia
                const height = 519; // Usa l'altezza fissa per la copia
                
                const scaleFactor = 2;
                canvas.width = width * scaleFactor;
                canvas.height = height * scaleFactor;
                
                const ctx = canvas.getContext("2d");
                ctx.scale(scaleFactor, scaleFactor);

                const img = new Image();
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);

                img.onload = async () => {
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(url);
                    canvas.toBlob(async (blob) => {
                        try {
                            await navigator.clipboard.write([
                                new ClipboardItem({ 'image/png': blob })
                            ]);
                            showFeedbackOnCopyButton(button, 'OK!');
                        } catch (err) {
                           console.error('Errore durante la scrittura negli appunti:', err);
                           showFeedbackOnCopyButton(button, 'Err!');
                        }
                    }, 'image/png');
                };
                img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    console.error('Errore nel caricare l\'immagine SVG nel canvas', e);
                    showFeedbackOnCopyButton(button, 'Err!');
                };
                img.src = url;

            } catch (err) {
                console.error('Errore durante la copia del grafico:', err);
                showFeedbackOnCopyButton(button, 'Err!');
            }
        }
        
        function exportSvg(svgElement, filename) {
            try {
                const svgData = getStyledSvgString(svgElement);
                const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Errore durante l\'esportazione del SVG:', err);
            }
        }
        
        function processFiles(fileData) {
            const fansGlobaleWorkbook = Object.values(fileData).find(wb => wb.SheetNames.includes('Total community size'));
            const competitorWorkbook = Object.values(fileData).find(wb => wb.SheetNames.includes('COMPETITORS'));

            if (!fansGlobaleWorkbook || !competitorWorkbook) {
                alert("Assicurati di aver caricato sia il file 'Report - Fans globale' che quello dei 'Competitor'.");
                return;
            }

            buttonNav.innerHTML = '';
            sectionsWrapper.innerHTML = '';

            const totalCommunitySheet = getSheetData(fansGlobaleWorkbook, 'Total community size');
            
            let totalCommunitySize = 0, relativeChange = '0%', totalGrowth = 0;

            const headerRowIndex = totalCommunitySheet.findIndex(row => row && String(row[2]).toLowerCase().includes('relative change'));
            if (headerRowIndex > -1 && totalCommunitySheet.length > headerRowIndex + 1) {
                const dataRow = totalCommunitySheet[headerRowIndex + 1];
                totalCommunitySize = Number(dataRow[0]);
                const previousTotal = Number(dataRow[1]);
                relativeChange = String(dataRow[2]);
                totalGrowth = totalCommunitySize - previousTotal;
            }
            
            const perPiattaformaSheet = getSheetData(fansGlobaleWorkbook, 'Fans Poste per piattaforma');
            const platformData = perPiattaformaSheet.slice(findRowIndex(perPiattaformaSheet, 'facebook'));

            const nameMaps = {            
                fb: { 'Vodafone it (https://www.facebook.com/vodafoneit)': 'Vodafone', 'TIM (https://www.facebook.com/TimOfficialPage)': 'Tim', 'WINDTRE (https://www.facebook.com/WINDTRE)': 'WindTre', 'PosteMobile (https://www.facebook.com/postemobile)': 'PosteMobile', 'Poste Italiane (https://www.facebook.com/PosteItaliane)': 'Poste Italiane', 'Frecciarossa (https://www.facebook.com/FrecciarossaOfficial)': 'Frecciarossa', 'Intesa Sanpaolo (https://www.facebook.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Revolut (https://www.facebook.com/revolutapp)': 'Revolut', 'Fastweb (https://www.facebook.com/Fastweb)': 'Fastweb', 'Deutsche Post und DHL (https://www.facebook.com/deutschepost)': 'Deutsche Post', 'iliad (https://www.facebook.com/iliadItalia)': 'Iliad', 'Eni (https://www.facebook.com/EniItalia)': 'Eni', 'Enel Group (https://www.facebook.com/EnelGroup)': 'Enel', 'Postepay (https://www.facebook.com/Postepay)': 'Postepay', 'Mooney Group (https://www.facebook.com/mooneygroup)': 'Mooney', 'DHL Express Italy (https://www.facebook.com/DHLExpressItaly)': 'DHL Italia', 'Royal Mail Stamps & Collectibles (https://www.facebook.com/RoyalMailStamps)': 'Royal Mail', 'HYPE (https://www.facebook.com/Hype.MoneyIsJustaTool)': 'Hype', 'ho. Mobile (https://www.facebook.com/homobile)': 'ho. Mobile', 'Banca Monte dei Paschi di Siena (https://www.facebook.com/bancamps)': 'Banca MPS', 'NeN (https://www.facebook.com/nen.energia)': 'NeN' },
                x: { 'Royal Mail (https://twitter.com/RoyalMail)': 'Royal Mail', 'Poste Italiane (https://twitter.com/PosteItaliane)': 'Poste Italiane', 'Frecciarossa_IT (https://twitter.com/Frecciarossa_IT)': 'Frecciarossa', 'PosteSpedizioni (https://twitter.com/PosteSpedizioni)': 'PosteSpedizioni', 'eni (https://twitter.com/eni)': 'Eni', 'WebPoste (https://twitter.com/WebPoste)': 'WebPoste', 'Deutsche Post und DHL News (https://twitter.com/DeutschePostDHL)': 'Deutsche Post', 'UniCredit Italia (https://twitter.com/UniCredit_IT)': 'UniCredit', 'Enel Group (https://twitter.com/EnelGroupIT)': 'Enel', 'Intesa Sanpaolo (https://twitter.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Banca MPS (https://twitter.com/Banca_MPS)': 'Banca MPS', 'revolut (https://twitter.com/revolut)': 'Revolut' },
                li: { 'Poste Italiane': 'Poste Italiane', 'Intesa Sanpaolo': 'Intesa Sanpaolo', 'Eni': 'Eni', 'Trenitalia': 'Trenitalia', 'INPS_official': 'INPS', 'CDP Cassa Depositi e Prestiti': 'CDP', 'BNL BNP Paribas': 'BNL BNP Paribas', 'UniCredit': 'UniCredit', 'Enel Group': 'Enel', 'Gruppo Ferrovie dello Stato Italiane': 'Gruppo FS' },
                ig: { 'Vodafone It (https://instagram.com/vodafoneit)': 'Vodafone', 'TIM (https://instagram.com/timofficial)': 'Tim', 'Royal Mail 📮 (https://instagram.com/royalmailofficial)': 'Royal Mail', 'Poste Italiane (https://instagram.com/posteitaliane)': 'Poste Italiane', 'WINDTRE (https://instagram.com/windtre)': 'WindTre', 'Intesa Sanpaolo (https://instagram.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Eni (https://instagram.com/eni)': 'Eni', 'Enel Group (https://instagram.com/enelgroup)': 'Enel', 'DHL Express Italy (https://instagram.com/dhlexpressitaly)': 'DHL Italia', 'Postepay (https://instagram.com/postepay)': 'Postepay', 'Banca Monte dei Paschi di Siena (https://instagram.com/banca_mps)': 'Banca MPS' }
            };

            const cleanName = (row, platform) => {
                const originalName = String(row[0]).trim();
                const platformMap = nameMaps[platform] || {};
                const rewrittenName = platformMap[originalName] || originalName.split('(')[0].trim();
                return { name: rewrittenName, value: row[1] };
            };

            const fbFollowersSheet = getSheetData(fansGlobaleWorkbook, 'FB Followers');
            const fbData = fbFollowersSheet.slice(findRowIndex(fbFollowersSheet, 'vodafone')).map(r => cleanName(r, 'fb')).sort((a,b) => b.value - a.value);

            const igFollowersSheet = getSheetData(fansGlobaleWorkbook, 'IG followers');
            const igData = igFollowersSheet.slice(findRowIndex(igFollowersSheet, 'tim')).map(r => cleanName(r, 'ig')).sort((a,b) => b.value - a.value);

            const xFollowersSheet = getSheetData(fansGlobaleWorkbook, 'X followers');
            const xData = xFollowersSheet.slice(findRowIndex(xFollowersSheet, 'royal mail')).map(r => cleanName(r, 'x')).sort((a,b) => b.value - a.value);

            const competitorSheet = getSheetData(competitorWorkbook, 'COMPETITORS');
            const linkedInData = competitorSheet.slice(2).map(r => cleanName(r, 'li')).sort((a,b) => b.value - a.value);

            const sections = {
                'dati-generali': { title: 'Dati Generali Poste', content: `
                    <div class="data-grid">
                        <div class="data-item">
                            <h3>Dimensione totale community</h3>
                            <button class="copy-button" title="Copia valore"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg></button>
                            <p class="data-value" data-copy-target>${formatNumber(totalCommunitySize)}</p>
                        </div>
                        <div class="data-item">
                             <h3>Variazione vs Mese Prec.</h3>
                             <button class="copy-button" title="Copia valore"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg></button>
                            <p class="data-value ${String(relativeChange).includes('-') ? 'negative' : 'positive'}" data-copy-target>${String(relativeChange).replace('.', ',')}</p>
                        </div>
                        <div class="data-item">
                             <h3>Crescita Totale nel Mese</h3>
                             <button class="copy-button" title="Copia valore"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg></button>
                            <p class="data-value positive" data-copy-target>+${formatNumber(totalGrowth)}</p>
                        </div>
                    </div>
                ` },
                'dati-piattaforma': { title: 'Dati per Piattaforma', content: createTableHTML(platformData, ['Piattaforma', 'Followers'], 'Followers per Piattaforma') },
                'benchmark-fb': { title: 'Benchmark Facebook', data: fbData, chartTitle: 'FACEBOOK' },
                'benchmark-ig': { title: 'Benchmark Instagram', data: igData, chartTitle: 'INSTAGRAM' },
                'benchmark-x': { title: 'Benchmark X', data: xData, chartTitle: 'X' },
                'benchmark-linkedin': { title: 'Benchmark LinkedIn', data: linkedInData, chartTitle: 'LINKEDIN' },
            };

            let isFirst = true;
            for (const [id, section] of Object.entries(sections)) {
                const button = document.createElement('button');
                button.className = `nav-button ${isFirst ? 'active' : ''}`;
                button.textContent = section.title;
                button.dataset.section = id;
                buttonNav.appendChild(button);

                const sectionDiv = document.createElement('div');
                sectionDiv.id = id;
                sectionDiv.className = `report-section ${!isFirst ? 'hidden' : ''}`;
                
                if (id.startsWith('benchmark-')) {
                   sectionDiv.innerHTML = `
                     <div class="chart-wrapper">
                         <div class="chart-controls">
                             <button class="export-svg-btn" data-chart-id="${id}-chart-container" title="Esporta SVG">Esporta SVG</button>
                             <button class="copy-svg-btn" data-chart-id="${id}-chart-container" title="Copia Grafico">Copia Grafico</button>
                         </div>
                         <div class="chart-container" id="${id}-chart-container"></div>
                     </div>
                     ${createTableHTML(section.data.map(d => [d.name, d.value]), ['Pagina', 'Followers'], section.title)}
                   `;
                } else {
                    sectionDiv.innerHTML = section.content;
                }
                sectionsWrapper.appendChild(sectionDiv);
                
                if (id.startsWith('benchmark-')) {
                   createBenchmarkChart(`#${id}-chart-container`, section.data, section.chartTitle);
                }

                isFirst = false;
            }

            reportContent.classList.remove('hidden');
        }

        function createTableHTML(data, headers, title) {
            let tableRows = data.map(row => `<tr>${row.map((cell, index) => `<td>${index === 1 && typeof cell === 'number' ? formatNumberWithThousands(cell) : cell}</td>`).join('')}</tr>`).join('');
            return `
                <div class="table-wrapper">
                    <button class="copy-button" title="Copia tabella"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg></button>
                    <h3>${title}</h3>
                    <table data-copy-target>
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;
        }

        function showFeedbackOnCopyButton(button, message) {
            const originalContent = button.innerHTML;
            button.innerHTML = message;
            setTimeout(() => {
                button.innerHTML = originalContent;
            }, 1500);
        }
        
        buttonNav.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.nav-button');
            if (!clickedButton) return;
            const sectionId = clickedButton.dataset.section;
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            document.querySelectorAll('.report-section').forEach(section => section.classList.toggle('hidden', section.id !== sectionId));
        });

        sectionsWrapper.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-button');
            const exportBtn = e.target.closest('.export-svg-btn');
            const copyChartBtn = e.target.closest('.copy-svg-btn');
            
            if (copyBtn) {
                const parentWrapper = copyBtn.closest('.data-item, .table-wrapper');
                const target = parentWrapper.querySelector('[data-copy-target]');
                if (!target) return;
                
                let textToCopy = '';
                if (target.tagName === 'TABLE') {
                    const rows = target.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        const rowText = Array.from(cells).map(cell => cell.innerText.trim()).join('\t');
                        textToCopy += rowText + '\n';
                    });
                } else {
                    textToCopy = target.innerText.trim();
                }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showFeedbackOnCopyButton(copyBtn, 'OK!');
                }).catch(err => {
                    console.error('Errore durante la copia:', err);
                    showFeedbackOnCopyButton(copyBtn, 'Err');
                });
            } else if (exportBtn) {
                const chartContainerId = exportBtn.dataset.chartId;
                const svgElement = document.querySelector(`#${chartContainerId} svg`);
                if(svgElement) {
                    exportSvg(svgElement, `${chartContainerId}.svg`);
                    showFeedbackOnCopyButton(exportBtn, 'OK!');
                } else {
                    showFeedbackOnCopyButton(exportBtn, 'Err!');
                }
            } else if (copyChartBtn) {
                 const chartContainerId = copyChartBtn.dataset.chartId;
                 const svgElement = document.querySelector(`#${chartContainerId} svg`);
                 if(svgElement) {
                    copySvgToClipboard(svgElement, copyChartBtn);
                 } else {
                    showFeedbackOnCopyButton(copyChartBtn, 'Err!');
                 }
            }
        });
    });
    </script>
</body>
</html>

