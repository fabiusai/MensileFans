<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Mensile Followers</title>
    <!-- Libreria per leggere i file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #004282; /* Blu istituzionale */
            --secondary-color: #ffd400; /* Giallo istituzionale */
            --background-color: #f4f7fa;
            --text-color: #333333;
            --card-background: #ffffff;
            --border-color: #e0e0e0;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            border-bottom: 5px solid var(--secondary-color);
        }

        header h1 {
            font-weight: 600;
        }

        main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .file-upload-wrapper {
            margin: 1.5rem 0;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .file-input-group {
            flex: 1;
            min-width: 250px;
        }

        .file-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #fafafa;
        }

        button {
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-align: center;
        }

        #process-button {
            background-color: var(--primary-color);
            color: white;
            display: block;
            width: 100%;
            max-width: 250px;
            margin: 1rem auto 0;
        }

        #process-button:hover {
            background-color: #003366; /* Blu piÃ¹ scuro */
        }
        
        #process-button:disabled {
            background-color: #a0b4c8;
            cursor: not-allowed;
        }

        #section-nav-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .nav-button {
            flex-grow: 1;
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            padding: 0.6rem 1rem;
            font-weight: 600;
        }
        
        .nav-button:hover {
            background-color: #f0f5fa;
            border-color: var(--primary-color);
        }

        .nav-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .report-section {
            padding: 2rem;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .data-item {
            background-color: #f9f9f9;
            padding: 1.5rem;
            border-radius: 6px;
            border: 1px solid #eee;
            position: relative;
        }

        .data-item h3 {
            font-size: 1rem;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .data-item p {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        thead th {
            background-color: #f1f1f1;
            color: var(--primary-color);
            font-weight: 600;
        }

        .numeric-cell {
            text-align: right;
        }

        tbody tr:hover {
            background-color: #f9f9f9;
        }

        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            padding: 0;
        }
        .copy-button:hover {
            background-color: var(--secondary-color);
        }
        .copy-button svg {
            width: 16px;
            height: 16px;
            fill: #333;
        }
        .copy-button.table-copy {
            position: static;
            display: inline-flex;
            margin-left: 1rem;
            vertical-align: middle;
        }

        .table-wrapper {
            position: relative;
        }
        .table-wrapper > h2, .table-wrapper > h3 {
            display: inline-block;
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 992px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            main { padding: 1rem; }
            header { padding: 1rem; }
            .file-upload-wrapper { flex-direction: column; gap: 1.5rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Report Mensile Followers</h1>
    </header>

    <main>
        <div id="upload-container" class="card">
            <h2>Caricamento File</h2>
            <p>Carica i report per generare l'analisi.</p>
            <div class="file-upload-wrapper">
                <div class="file-input-group">
                    <label for="file-report1">1. Report Emplifi (Fans Globale)</label>
                    <input type="file" id="file-report1" accept=".xlsx">
                </div>
                <div class="file-input-group">
                    <label for="file-report2">2. Report LinkedIn (Competitor Analytics)</label>
                    <input type="file" id="file-report2" accept=".xlsx">
                </div>
            </div>
            <button id="process-button">Genera Report</button>
        </div>

        <div id="results-container" class="hidden">
            <div id="section-nav-container">
                <button class="nav-button active" data-section="sintesi-gruppo">Sintesi dati di Gruppo</button>
                <button class="nav-button" data-section="benchmark-fb">Benchmark Facebook</button>
                <button class="nav-button" data-section="benchmark-x">Benchmark X</button>
                <button class="nav-button" data-section="benchmark-linkedin">Benchmark Linkedin</button>
                <button class="nav-button" data-section="benchmark-ig">Benchmark Instagram</button>
            </div>

            <div id="sections-wrapper">
                <section id="sintesi-gruppo" class="report-section"></section>
                <section id="benchmark-fb" class="report-section hidden"></section>
                <section id="benchmark-x" class="report-section hidden"></section>
                <section id="benchmark-linkedin" class="report-section hidden"></section>
                <section id="benchmark-ig" class="report-section hidden"></section>
            </div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const processButton = document.getElementById('process-button');
        const fileInput1 = document.getElementById('file-report1');
        const fileInput2 = document.getElementById('file-report2');
        const uploadContainer = document.getElementById('upload-container');
        const resultsContainer = document.getElementById('results-container');
        const sectionNavContainer = document.getElementById('section-nav-container');
        const sectionsWrapper = document.getElementById('sections-wrapper');

        const fbNameMap = { 'Vodafone it (https://www.facebook.com/vodafoneit)': 'Vodafone', 'TIM (https://www.facebook.com/TimOfficialPage)': 'Tim', 'WINDTRE (https://www.facebook.com/WINDTRE)': 'WindTre', 'PosteMobile (https://www.facebook.com/postemobile)': 'PosteMobile', 'Poste Italiane (https://www.facebook.com/PosteItaliane)': 'Poste Italiane', 'Frecciarossa (https://www.facebook.com/FrecciarossaOfficial)': 'Frecciarossa', 'Intesa Sanpaolo (https://www.facebook.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Revolut (https://www.facebook.com/revolutapp)': 'Revolut', 'Fastweb (https://www.facebook.com/Fastweb)': 'Fastweb', 'Deutsche Post und DHL (https://www.facebook.com/deutschepost)': 'Deutsche Post', 'iliad (https://www.facebook.com/iliadItalia)': 'Iliad', 'Eni (https://www.facebook.com/EniItalia)': 'Eni', 'Enel Group (https://www.facebook.com/EnelGroup)': 'Enel', 'Postepay (https://www.facebook.com/Postepay)': 'Postepay', 'Mooney Group (https://www.facebook.com/mooneygroup)': 'Mooney', 'DHL Express Italy (https://www.facebook.com/DHLExpressItaly)': 'Dhl Italia', 'Royal Mail Stamps & Collectibles (https://www.facebook.com/RoyalMailStamps)': 'Royal Mail', 'HYPE (https://www.facebook.com/Hype.MoneyIsJustaTool)': 'Hype', 'ho. Mobile (https://www.facebook.com/homobile)': 'Ho Mobile', 'Banca Monte dei Paschi di Siena (https://www.facebook.com/bancamps)': 'Banca MPS', 'NeN (https://www.facebook.com/nen.energia)': 'NeN' };
        const xNameMap = { 'Royal Mail (https://twitter.com/RoyalMail)': 'Royal Mail', 'Poste Italiane (https://twitter.com/PosteItaliane)': 'Poste Italiane', 'Frecciarossa_IT (https://twitter.com/Frecciarossa_IT)': 'Frecciarossa', 'PosteSpedizioni (https://twitter.com/PosteSpedizioni)': 'PosteSpedizioni', 'eni (https://twitter.com/eni)': 'Eni', 'WebPoste (https://twitter.com/WebPoste)': 'WebPoste', 'Deutsche Post und DHL News (https://twitter.com/DeutschePostDHL)': 'Deutsche Post', 'UniCredit Italia (https://twitter.com/UniCredit_IT)': 'UniCredit', 'Enel Group (https://twitter.com/EnelGroupIT)': 'Enel', 'Intesa Sanpaolo (https://twitter.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Banca MPS (https://twitter.com/Banca_MPS)': 'Banca MPS' };
        const liNameMap = { 'Poste Italiane': 'Poste Italiane', 'Intesa Sanpaolo': 'Intesa Sanpaolo', 'Eni': 'Eni', 'Trenitalia': 'Trenitalia', 'INPS_official': 'Inps', 'CDP Cassa Depositi e Prestiti': 'Cassa Depositi e Prestiti', 'BNL BNP Paribas': 'BNL BNP Paribas', 'UniCredit': 'UniCredit', 'Enel Group': 'Enel', 'Gruppo Ferrovie dello Stato Italiane': 'Gruppo FS' };
        const igNameMap = { 'Vodafone It (https://instagram.com/vodafoneit)': 'Vodafone', 'TIM (https://instagram.com/timofficial)': 'Tim', 'Royal Mail ðŸ“® (https://instagram.com/royalmailofficial)': 'Royal Mail', 'Poste Italiane (https://instagram.com/posteitaliane)': 'Poste Italiane', 'WINDTRE (https://instagram.com/windtre)': 'Wind Tre', 'Intesa Sanpaolo (https://instagram.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Eni (https://instagram.com/eni)': 'Eni', 'Enel Group (https://instagram.com/enelgroup)': 'Enel', 'DHL Express Italy (https://instagram.com/dhlexpressitaly)': 'Dhl Italia', 'Postepay (https://instagram.com/postepay)': 'Postepay', 'Banca Monte dei Paschi di Siena (https://instagram.com/banca_mps)': 'Banca MPS' };

        const formatNumberK_M = (num) => { if (num >= 1000000) return `${(num / 1000000).toFixed(2).replace(/\.00$/, '').replace(/\.([1-9])0$/, '.$1')}M`; if (num >= 1000) return `${(num / 1000).toFixed(1).replace(/\.0$/, '')}K`; return num.toString(); };
        const convertExcelDate = (excelDate) => { if (typeof excelDate !== 'number' || excelDate < 1) return excelDate; const date = new Date((excelDate - 25569) * 86400 * 1000); const day = String(date.getUTCDate()).padStart(2, '0'); const month = String(date.getUTCMonth() + 1).padStart(2, '0'); const year = date.getUTCFullYear(); return `${day}/${month}/${year}`; };
        const createCopyButton = (isTable = false) => { const btnClass = isTable ? 'copy-button table-copy' : 'copy-button'; return `<button class="${btnClass}" title="Copia"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>`; };
        const showFeedbackOnButton = (button, message, originalText) => { button.textContent = message; setTimeout(() => { button.textContent = originalText; }, 1500); };
        const showFeedbackOnCopyButton = (button, message) => { const originalContent = button.innerHTML; button.innerHTML = `<span style="font-size: 12px; font-weight: 600;">${message}</span>`; setTimeout(() => { button.innerHTML = originalContent; }, 1500); };
        const findSheetFuzzy = (workbook, targetName) => { const normalizedTarget = targetName.toLowerCase().trim(); const sheetName = workbook.SheetNames.find(name => name.toLowerCase().trim() === normalizedTarget); return sheetName ? workbook.Sheets[sheetName] : null; };

        const renderSintesi = (summarySheet, growthSheet, channelSheet) => {
            const totalFollowers = summarySheet['A13'] ? summarySheet['A13'].v : 0;
            const prevMonthFollowers = summarySheet['B13'] ? summarySheet['B13'].v : 0;
            const variation = totalFollowers - prevMonthFollowers;
            const relativeVariation = summarySheet['C13'] ? summarySheet['C13'].w : 'N/D';

            let trendData = [];
            if (growthSheet) {
                const growthData = XLSX.utils.sheet_to_json(growthSheet, { header: 1, range: "A13:B43", defval: null });
                trendData = growthData
                    .filter(row => row && row.length >= 2 && row[0] !== null && row[1] !== null)
                    .map(row => ({ col1: typeof row[0] === 'number' ? convertExcelDate(row[0]) : row[0], col2: !isNaN(parseFloat(row[1])) ? parseFloat(row[1]).toLocaleString('it-IT') : row[1] }));
            }
            
            let channelData = [];
            if (channelSheet) {
                const rawChannelData = XLSX.utils.sheet_to_json(channelSheet, { header: 1, range: "A13:B17", defval: null });
                channelData = rawChannelData
                    .filter(row => row && row.length >= 2 && row[0] !== null && row[1] !== null)
                    .map(row => ({ canale: row[0], followers: !isNaN(parseFloat(row[1])) ? parseFloat(row[1]).toLocaleString('it-IT') : row[1] }));
            }
           
            const html = `<h2>Sintesi dati di Gruppo</h2><div class="data-grid"><div class="data-item">${createCopyButton()}<h3>Totale iscritti ai canali</h3><p data-copy-target>${formatNumberK_M(totalFollowers)}</p></div><div class="data-item">${createCopyButton()}<h3>Variazione vs mese precedente</h3><p data-copy-target>${variation > 0 ? '+' : ''}${variation.toLocaleString('it-IT')}</p></div><div class="data-item">${createCopyButton()}<h3>Variazione relativa vs mese precedente</h3><p data-copy-target>${relativeVariation}</p></div></div><div class="tables-container"><div class="table-wrapper"><h3>Andamento crescita ultimo mese ${createCopyButton(true)}</h3><table data-copy-target><thead><tr><th>Data</th><th class="numeric-cell">Followers</th></tr></thead><tbody>${trendData.map(row => `<tr><td>${row.col1}</td><td class="numeric-cell">${row.col2}</td></tr>`).join('')}</tbody></table></div><div class="table-wrapper"><h3>Follower per canale ${createCopyButton(true)}</h3><table data-copy-target><thead><tr><th>Canale</th><th class="numeric-cell">Followers</th></tr></thead><tbody>${channelData.map(row => `<tr><td>${row.canale}</td><td class="numeric-cell">${row.followers}</td></tr>`).join('')}</tbody></table></div></div>`;
            document.getElementById('sintesi-gruppo').innerHTML = html;
        };

        const renderBenchmark = (sheet, range, nameMap, elementId, title) => {
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1, range: range, defval: null });
            const processedData = data.map(row => ({ page: (row && row.length > 0 && row[0] !== null) ? (nameMap[row[0].trim()] || row[0].trim()) : '', followers: (row && row.length >= 2) ? parseFloat(row[1]) : NaN })).filter(item => item.page && !isNaN(item.followers)).sort((a, b) => b.followers - a.followers);
            const html = `<div class="table-wrapper"><h2>${title} ${createCopyButton(true)}</h2><table data-copy-target><thead><tr><th>Pagina</th><th class="numeric-cell">Followers</th></tr></thead><tbody>${processedData.map(row => `<tr><td>${row.page}</td><td class="numeric-cell">${row.followers.toLocaleString('it-IT')}</td></tr>`).join('')}</tbody></table></div>`;
            document.getElementById(elementId).innerHTML = html;
        };

        processButton.addEventListener('click', () => {
            if (!fileInput1.files[0] || !fileInput2.files[0]) { alert('Per favore, carica entrambi i file Excel.'); return; }
            const originalButtonText = processButton.textContent;
            processButton.textContent = "Caricamento...";
            processButton.disabled = true;

            // --- LOGICA DI LETTURA FILE CORRETTA E ROBUSTA ---
            const readFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(new Uint8Array(e.target.result));
                    reader.onerror = e => reject(new Error(`Errore durante la lettura del file ${file.name}`));
                    reader.readAsArrayBuffer(file);
                });
            };

            Promise.all([readFile(fileInput1.files[0]), readFile(fileInput2.files[0])]).then(([data1, data2]) => {
                try {
                    const workbook1 = XLSX.read(data1, { type: 'array' });
                    const workbook2 = XLSX.read(data2, { type: 'array' });

                    const sheetsToFind1 = { summarySheet: 'Total community size', growthSheet: 'Fans Poste Crescita', channelSheet: 'Fans Poste per piattaforma', fbSheet: 'FB Followers', xSheet: 'X Followers', igSheet: 'IG followers' };
                    const sheetsToFind2 = { liSheet: 'COMPETITORS' };
                    let foundSheets = {}, missingSheets = [];

                    for (const [key, name] of Object.entries(sheetsToFind1)) { if (!(foundSheets[key] = findSheetFuzzy(workbook1, name))) missingSheets.push(name); }
                    for (const [key, name] of Object.entries(sheetsToFind2)) { if (!(foundSheets[key] = findSheetFuzzy(workbook2, name))) missingSheets.push(`${name} (dal file 2)`); }

                    if (missingSheets.length > 0) { throw new Error(`I seguenti fogli non sono stati trovati: [${missingSheets.join(', ')}].\n\nFogli disponibili nel file 1: [${workbook1.SheetNames.join(', ')}]\nFogli disponibili nel file 2: [${workbook2.SheetNames.join(', ')}]`); }

                    renderSintesi(foundSheets.summarySheet, foundSheets.growthSheet, foundSheets.channelSheet);
                    renderBenchmark(foundSheets.fbSheet, 'A16:B36', fbNameMap, 'benchmark-fb', 'Benchmark Facebook');
                    renderBenchmark(foundSheets.liSheet, 'A3:B12', liNameMap, 'benchmark-linkedin', 'Benchmark Linkedin');
                    renderBenchmark(foundSheets.xSheet, 'A16:B26', xNameMap, 'benchmark-x', 'Benchmark X');
                    renderBenchmark(foundSheets.igSheet, 'A16:B26', igNameMap, 'benchmark-ig', 'Benchmark Instagram');

                    uploadContainer.classList.add('hidden');
                    resultsContainer.classList.remove('hidden');
                    
                    const navButtons = sectionNavContainer.querySelectorAll('.nav-button');
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    sectionNavContainer.querySelector('[data-section="sintesi-gruppo"]').classList.add('active');
                    document.querySelectorAll('.report-section').forEach(section => section.classList.add('hidden'));
                    document.getElementById('sintesi-gruppo').classList.remove('hidden');
                    
                    showFeedbackOnButton(processButton, 'Fatto!', originalButtonText);
                } catch (error) {
                    console.error("Errore durante l'elaborazione dei file:", error);
                    alert(`Si Ã¨ verificato un errore:\n\n${error.message}`);
                    showFeedbackOnButton(processButton, 'Errore!', originalButtonText);
                } finally {
                    processButton.disabled = false;
                }
            });
        });

        sectionNavContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.nav-button');
            if (!clickedButton) return;
            const sectionId = clickedButton.dataset.section;
            sectionNavContainer.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            document.querySelectorAll('.report-section').forEach(section => section.classList.toggle('hidden', section.id !== sectionId));
        });

        sectionsWrapper.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-button');
            if (!copyBtn) return;
            const parentWrapper = copyBtn.closest('.data-item, .table-wrapper');
            if (!parentWrapper) return;
            const target = parentWrapper.querySelector('[data-copy-target]');
            if (!target) return;
            let textToCopy = '';
            if (target.tagName === 'TABLE') {
                const rows = target.querySelectorAll('tr');
                rows.forEach(row => { const cells = row.querySelectorAll('th, td'); const rowText = Array.from(cells).map(cell => cell.innerText.trim()).join('\t'); textToCopy += rowText + '\n'; });
            } else { textToCopy = target.innerText.trim(); }
            navigator.clipboard.writeText(textToCopy).then(() => { showFeedbackOnCopyButton(copyBtn, 'OK!'); }).catch(err => { console.error('Errore durante la copia:', err); showFeedbackOnCopyButton(copyBtn, 'Err'); });
        });
    });
    </script>
</body>
</html>
